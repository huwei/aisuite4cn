# -*- coding: utf-8 -*-
from dotenv import load_dotenv

import aisuite4cn as ai

# 加载 .env 文件中的环境变量
load_dotenv()

client = ai.Client()

provider = "dmxapi"
model_id = "gemini-2.5-flash-nothinking"

prompt = """
# Role
你是一位顶级的高分子材料科学家，拥有极其敏锐的观察力和深厚的图谱分析功底。你的分析报告以“详尽、严谨、无一疏漏”而著称。

# Knowledge Base
以我提供的文件《高分子科学图谱分析要点》为唯一的、最高优先级的分析依据。文件中的“分析维度”和“物理意义”是你进行专业解读的核心指南。

# Primary Directive
你的核心任务不是总结，而是**详尽地展示分析过程**。按照论文中图片出现的顺序，对于每一张图，你必须先分解并呈现所有可观察到的信息，然后再进行归纳总结。把所有能从图里看出来的、算出来的、比出来的东西都写出来。同时不要有冗余的语言。

# Workflow
0.  **图像内容预筛选 **:
    * 首先，判断传入的图片是否为包含数据和轴的科学图谱（如TGA, DSC, SEM, TEM, XRD, FTIR等）。
    * 如果图片是出版商logo、期刊封面、作者照片、或任何装饰性图片，则将该图片判定为“无效图片”。如果图片中没有任何论文中的图谱，也判定为无效照片。但请注意，流程图，示意图等等都是有效照片。
    * **如果判定为无效图片，你的唯一输出必须是且仅是这三个词：`无效图片，跳过。`** 否则，请继续执行后续所有步骤。

1.  **识别与分类**: 识别图片基本类型，并判断是否与知识库匹配。
2.  **详尽分析 (关键步骤)**: 这是你最重要的任务。你必须对图谱进行地毯式分析，包括但不限于：
    * **定量数据提取**: 读取所有曲线的峰值、谷值、拐点、起始点、终点、斜率、面积、半峰宽等具体坐标和数值。
    * **定性特征观察**: 描述曲线的形状（尖锐/宽平）、对称性、基线漂移、有无肩峰、噪声水平等特征。
    * **对比分析**: 如果图中有多条曲线，必须进行详细的横向对比。例如，“与曲线A相比，曲线B的XX峰向高温方向移动了5.6°C，且峰面积减小了约15%，这表明...”。
    * **关联知识库**: 在分析时，就要思考这些现象对应知识库里的哪些物理意义。
3.  **归纳与格式化**: 将上述分析结果，按照下面全新的、层次分明的模板进行组织。
# Output Template

**图片标题：[请填写图片编号]**

图片内容：[对图谱类型的简要描述。例如：不同配比的样品A、B、C的TGA和DTG曲线。]

---
**详细图谱分析：**

* **数据提取与特征观察**:
    * **对于样品A**:
        * TGA曲线显示，其失重起始温度 (Tonset) 约为 [数值]°C。
        * 主要失重阶段发生在 [温度范围]，在 [数值]°C (Tmax) 时达到最大失重速率。
        * 此阶段失重量为 [数值]%。
        * DTG峰型态 [尖锐/宽平]，表明分解过程 [集中/分散]。
        * 在 [温度]°C 后的最终残余量为 [数值]%。
    * **对于样品B**:
        * (同上，对样品B进行细致描述...)
    * ... (依次分析图中所有样品)

* **对比分析**:
    * **热稳定性**: 对比Tonset和Tmax，三者的热稳定性顺序为：样品C > 样品B > 样品A。样品C的Tmax相比A提高了约 [数值]°C。
    * **残余量**: 样品C的残余量最高 ([数值]%)，显著高于A和B，这可能与 [原因，例如：无机填料的引入] 有关 。
    * **分解行为**: 样品B的DTG峰相比A更宽，说明其分解过程更广。

---
**图片意义与结论：**

在此处对上述详细分析进行总结，提炼出核心结论。例如：该TGA分析表明，XX的引入显著提升了材料的热稳定性和残炭率。随着XX含量的增加（从A到C），材料的初始分解温度和最大分解速率温度均系统性提高，证明了XX有效抑制了高分子链的热降解过程

**核心物理参数：**

[此项完全对应知识库，作为最终的参数列表。]
* **样品A**:
    * 热分解温度 (Tmax): [数值] °C
    * 组分含量 (最终残余量): [数值] %
* **样品B**:
    * 热分解温度 (Tmax): [数值] °C
    * 组分含量 (最终残余量): [数值] %
* **样品C**:
    * 热分解温度 (Tmax): [数值] °C
    * 组分含量 (最终残余量): [数值] %


---《高分子科学图谱分析要点》 ---
<graph_analysis_guidelines>
## 一、力学性能 (Mechanical Properties)
### 1. 拉伸应力-应变曲线
- **测试方法:** 静态拉伸测试
- **分析维度:** 初始斜率、屈服点/峰值（对应的横纵坐标）、断裂点（对应的横纵坐标）、应力-应变曲线和横坐标围成的面积。
- **物理意义:** 分别对应材料的 `(杨氏模量)` (`E`, 刚度)、`(屈服/拉伸强度)` (`σy`, `σb`)、`(断裂伸长率)` (`εb`, 延展性) 和 `(韧性)` (断裂能)。
- **应用目的:** 综合评价材料的刚度、强度和韧性，判断其是 `(硬而脆)`、`(强而韧)` 还是 `(软而弹)`。

### 2. 压缩应力应变曲线
- **测试方法:** 静态压缩测试

### 3. 单搭接剪切应力应变曲线
- **测试方法:** Lap shear test，表征粘合剂的粘附强度。

### 4. 剥离曲线
- **测试方法:** Peeling test，表征粘合剂的界面粘附韧性 `(interfacial toughness)`。

## 二、热学性能 (Thermal Properties)

### 1. 差示扫描量热法 (DSC)
- **分析维度:** 基线阶跃、放热峰 (`Exo`)、吸热峰 (`Endo`) 的位置、形状和面积。
- **物理意义:** 解读出 `(玻璃化转变温度)` (`Tg`)、`(结晶温度)` (`Tc`)、`(熔融温度)` (`Tm`)。
- **应用目的:** 确定材料的 `(使用温度范围)`，评估其 `(热稳定性)` 和 `(结晶行为)`。

### 2. 热重分析 (TGA)
- **分析维度:** 失重起始温度 (`Tonset`)、最大失重速率温度 (`Tmax`)、失重台阶数量与高度、最终残余重量。
- **物理意义:** 对应 `(热分解温度)` (热稳定性)、`(组分含量)` (如水分、有机物、无机填料) 和 `(残余量)`。
- **应用目的:** 评估材料的 `(耐热性)` 和使用寿命，分析复合材料中各组分的 `(精确比例)`。

### 3. 动态力学分析 (DMA)
- **分析维度:** 储能模量 (`E'`) 的下降平台、损耗模量 (`E''`) 的峰值、损耗因子 (`tanδ`) 的峰值。
- **物理意义:** 反映材料 `(刚度随温度的变化)` (`E'`)、`(能量耗散能力)` (`E''`) 以及 `(阻尼/减震特性)` (`tanδ`)。
- **应用目的:** 精确测定 `(玻璃化转变)` (`Tg`) 和其他次级转变，研究材料的 `(粘弹性行为)`，评估 `(减震性能)`。


## 三、流变性能 (Rheological Properties)

### 1. 稳态剪切流变
- **分析维度:** 低剪切区的黏度平台 (牛顿平台)、高剪切区黏度下降的斜率 (幂律区)。
- **物理意义:** 得到 `(零剪切黏度)` (`η0`) (与分子量相关) 和 `(剪切变稀行为)` (链解缠与取向)。
- **应用目的:** 指导 `(加工工艺)` (如挤出、注塑)，预测材料的 `(加工流动性)`，间接评估 `(分子量大小)`。

### 2. 动态振荡流变
- **分析维度:** 储能模量 (`G'`) 与损耗模量 (`G''`) 的相对大小及频率/时间依赖性，二者的交点。
- **物理意义:** 判断材料的 `(粘弹特性)` (`G'`>`G''` 为类固态；`G''`>`G'` 为类液态)，确定 `(特征松弛时间)` 或 `(凝胶点)`。
- **应用目的:** 研究 `(凝胶化过程)` (如水凝胶固化)，分析高分子的 `(内部网络结构)` 和链纠缠。

## 四、结构与形貌 (Structure and Morphology)

### 1. 傅里叶变换红外光谱 (FTIR)
- **分析维度:** 特征吸收峰的位置 (波数)、强度、形状，以及反应前后峰的变化。
- **物理意义:** 实现 `(官能团鉴定)`、`(化学反应进程监控)` 和 `(组分识别)`。
- **应用目的:** `(快速鉴定未知物)` 的化学结构类别，监控固化、降解等 `(化学反应)`。

### 2. 核磁共振波谱 (NMR)
- **分析维度:** 化学位移 (`δ`)、积分面积、裂分模式、二维谱相关峰。
- **物理意义:** 确定 `(精确化学结构)`、`(立构规整度)` 和 `(链结构)` (序列、支化、端基)。
- **应用目的:** `(精确解析高分子)` 的“指纹级”链结构，是结构确证的 `(金标准)`。

### 3. 凝胶渗透色谱法 (GPC / SEC)
- **分析维度:** 洗脱曲线上峰的位置 (洗脱时间/体积)、峰的宽度与形状。
- **物理意义:** 计算 `(数均/重均分子量)` (`Mn`, `Mw`) 和 `(分子量分布指数)` (`PDI=Mw/Mn`)。
- **应用目的:** 测量高分子 `(最基本也是最重要的参数)`——分子量及其分布。

### 4. X射线衍射 (XRD)
- **分析维度:** 尖锐的衍射峰 (晶体) 和宽化的弥散包 (非晶)，分析峰的位置 (`2θ`) 和半峰宽。
- **物理意义:** 得到 `(结晶度)`、`(晶体结构与晶型)` 以及 `(晶粒尺寸)` (可估算)。
- **应用目的:** 区分材料是 `(晶态)` 还是 `(非晶态)`，鉴定晶体类型，研究结晶完整度。

### 5. 小角X射线散射 (SAXS)
- **分析维度:** 散射曲线 `I(q)` vs `q` 的形状、斜率和峰位。
- **物理意义:** 提供 `(纳米尺度 (1-100 nm))` 的结构信息，如微相分离的畴区尺寸、形状、周期性。
- **应用目的:** 研究嵌段共聚物的 `(自组装结构)`、纳米复合材料中 `(填料的分散状态)`。

### 6. 电子显微镜 (SEM / TEM)
- **分析维度:** 表面形貌、颗粒/纤维/孔洞尺寸、断裂面特征 (SEM)；内部相畴、晶格条纹 (TEM)。
- **物理意义:** 揭示材料的 `(微观形貌)`、`(相分离结构)` 和 `(断裂机理)`。
- **应用目的:** `(直观观察)` 材料的微观世界，分析多组分材料的 `(相容性)` 和分散情况。

### 7. 原子力显微镜 (AFM)
- **分析维度:** 高度图、相位图、力-距离曲线。
- **物理意义:** 获得 `(三维表面形貌与粗糙度)`、`(微相分离结构)` (通过模量差异) 和 `(纳米力学性质)`。
- **应用目的:** 在 `(纳米尺度)` 高分辨率成像表面形貌，区分不同组分构成的相区。

## 五、表面与界面性能 (Surface and Interface Properties)

### 1. 接触角测量 (Contact Angle Measurement)
- **分析维度:** 测量液滴在固体表面的静态或动态夹角。
- **物理意义:** 计算 `(表面自由能)`，判断润湿性。
- **应用目的:** 评价材料表面的 `(亲水/疏水性)`，用于涂料、生物相容性、粘接等领域。

### 2. X射线光电子能谱 (XPS)
- **分析维度:** 全谱中的元素峰位与面积，特定元素的高分辨谱及其分峰拟合。
- **物理意义:** 得到 `(表面元素组成与含量)` 和 `(元素的化学态/价态)`。
- **应用目的:** 分析材料 `(最表层 (<10nm))` 的化学信息，研究 `(表面改性、氧化或涂层)`。

## 六、光学与电学性能 (Optical and Electrical Properties)

### 1. 紫外-可见光谱 (UV-Vis Spectroscopy)
- **分析维度:** 吸收峰的位置 (`λmax`)、吸收强度 (吸光度)。
- **物理意义:** 鉴定 `(共轭体系或发色团)`，通过朗伯-比尔定律进行 `(浓度测定)`。
- **应用目的:** 研究 `(导电高分子)`、`(光致变色材料)`，或追踪 `(聚合反应或降解过程)`。

### 2. 介电谱/阻抗谱 (Dielectric/Impedance Spectroscopy)
- **分析维度:** 观察介电常数 (`ε'`)、介电损耗 (`ε''`) 随频率、温度的变化。
- **物理意义:** 反映材料 `(储存电荷的能力)` (`ε'`) 和 `(能量耗散的程度)` (`ε''`)。
- **应用目的:** 评价 `(绝缘性能)` 和 `(储能特性)`，用于电容器、高频电路基板等。

### 3. 电导率测试 (Conductivity Measurement)
- **分析维度:** 测量电阻或电导率 (`σ`)。
- **物理意义:** 材料传输电荷的能力。
- **应用目的:** 评价 `(导电高分子)`、`(抗静电材料)` 或 `(离子导电电解质)` 的性能。

## 七、特定应用性能 (Specific Application Properties)

### 1. 阻隔性能 (Barrier Properties)
- **测试方法:** 气体/水蒸气透过率测试
- **分析维度:** 气体透过系数 (`P`) 或透过速率 (如 `OTR`, `WVTR`)。
- **物理意义:** 衡量小分子穿透高分子薄膜的难易程度。
- **应用目的:** 评价 `(食品包装)`、`(保护涂层)` 和 `(分离膜)` 的核心性能。

### 2. 燃烧性能 (Combustion Properties)
- **测试方法:** 极限氧指数 (`LOI`)、锥形量热法
- **分析维度:** `LOI` 值、热释放速率 (`HRR`)、点燃时间 (`TTI`)。
- **物理意义:** 综合评价材料的 `(易燃性)` 和 `(燃烧时的危险性)`。
- **应用目的:** 开发和评价 `(阻燃材料)`，满足消防安全法规要求。

### 3. 生物相容性与降解 (Biocompatibility and Degradation)
- **测试方法:** 体外细胞毒性、溶血、降解实验等。
- **分析维度:** 细胞存活率、溶血率、材料性能随时间的变化。
- **物理意义:** 评价材料与生物体的 `(相容程度)` 和自身的 `(降解行为)`。
- **应用目的:** `(生物医用高分子)` (植入物、药物载体) 的核心安全与功能指标。

### 4. 溶液性质 (Solution Properties)
- **测试方法:** 动态光散射 (`DLS`)
- **分析维度:** 粒径（流体力学半径 `Rh`）分布、多分散性指数 (`PDI`)。
- **物理意义:** 测量高分子在溶液中形成的线团、聚集体或纳米粒子的尺寸。
- **应用目的:** 表征 `(纳米微球)`、`(胶束)`，研究高分子在溶液中的聚集行为。
</graph_analysis_guidelines>


"""

import base64


def encode_image(image_path):
    """将本地图片编码为Base64字符串"""
    with open(image_path, "rb") as image_file:
        return base64.b64encode(image_file.read()).decode("utf-8")


def read_markdown_file(file_path):
    """
    读取指定路径的 Markdown 文件内容。

    :param file_path: str, Markdown 文件的路径
    :return: str, 文件内容
    """
    with open(file_path, "r", encoding="utf-8") as file:
        content = file.read()
    return content


markdown_content = read_markdown_file("data/10_1021_acsnano_5b00147.md")

contents = [
    prompt,
    """
----- 下面是需要参与提取分析的原文内容 -------
<paper_content>
    """,
    markdown_content,
    """
    </paper_content>
    """
]

# 本地图片
image_data = encode_image("data/image3.png")

messages = [
    {
        "role": "user",
        "content": [
            {"type": "text", "text": ''.join(contents)},
            {
                "type": "image_url",
                "image_url": {
                    "url": f"data:image/png;base64,{image_data}"
                }
            }
        ]
    },
]

# stream = True
response = client.chat.completions.create(
    model=f"{provider}:{model_id}",
    messages=messages,
    stream=True
)

for chunk in response:

    if chunk.choices[0].delta.content:
        print(chunk.choices[0].delta.content, end='')

# stream = False
#
# response = client.chat.completions.create(
#     model=f"{provider}:{model_id}",
#     messages=messages,
#     stream=False
# )
#
# print(response.choices[0].message.content)
